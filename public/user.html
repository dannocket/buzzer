<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Quiz Buzzer</title>
    <link rel="stylesheet" href="/css/main.css" />
  </head>
  <body class="page-user">
    <h1>Ash & Dan's Halloween Jeopardy</h1>
    <div id="registrationForm">
      <h2>Register Your Name</h2>
      <form id="team-registration-form">
        <label for="team-name-input">Name</label>
        <input
          type="text"
          id="team-name-input"
          name="team-name"
          placeholder="Enter team name"
        />
        <button type="submit" id="register-button">Register</button>
      </form>
    </div>
    <div id="buzzerContainer">
      <div id="teamNameContainer">
        <span id="teamNameDisplay"></span>
        <span id="changeRegistration">&#x270E;</span>
      </div>
      <div id="teamDescriptionContainer"></div>
      <button id="buzzer-button">BUZZ!</button>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let teamName = "";
      let teamPin = "";
      let lastBuzzTime = 0;
      let reconnectionInterval;
      const buzzerButton = document.getElementById("buzzer-button");

      async function preventSleep() {
        try {
          const wakeLock = await navigator.wakeLock.request("screen");
          console.log("Wake lock is active");
          document.addEventListener("visibilitychange", async () => {
            if (document.visibilityState === "visible") {
              try {
                await wakeLock.release();
                await navigator.wakeLock.request("screen");
                console.log("Wake lock re-acquired");
              } catch (err) {
                console.error(`Error re-acquiring wake lock: ${err}`);
              }
            }
          });
        } catch (err) {
          console.error(`Error acquiring wake lock: ${err}`);
        }
      }

      preventSleep();

      function registerTeam() {
        teamName = document.getElementById("team-name-input").value.trim();
        if (teamName) {
          document.getElementById("team-name-input").disabled = true;
          document.getElementById("register-button").disabled = true;
          fetch("/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              teamName,
              socketId: socket.id,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                teamPin = data.pin;
                localStorage.setItem("teamName", teamName);
                localStorage.setItem("teamPin", teamPin);
              } else {
                alert("Registration failed: " + data.error);
                document.getElementById("team-name-input").disabled = false;
                document.getElementById("register-button").disabled = false;
              }
            });
        }
      }

      function attemptReconnection() {
        if (!socket.connected) {
          reRegister();
        } else {
          clearInterval(reconnectionInterval);
        }
      }

      socket.on("registrationApproved", (data) =>
        showBuzzer(data.teamName, data.description)
      );
      socket.on("registrationRemoved", (data) =>
        showRegistrationForm(data.teamName)
      );
      socket.on("teamUpdated", ({ teamName, description }) => {
        showBuzzer(teamName, description, null);
      });
      function showBuzzer(teamName, description = "", hasPressed = false) {
        document.getElementById("registrationForm").style.display = "none";
        document.getElementById("buzzerContainer").style.display = "block";
        document.getElementById("teamNameDisplay").textContent = teamName;
        document.getElementById("teamDescriptionContainer").textContent =
          description;
        if (null !== hasPressed) {
          buzzerButton.disabled = hasPressed;
        }
      }
      function showRegistrationForm(teamName = "") {
        document.getElementById("buzzerContainer").style.display = "none";
        document.getElementById("registrationForm").style.display = "block";
        const teamNameInput = document.getElementById("team-name-input");
        teamNameInput.value = teamName;
        teamNameInput.disabled = false;
        document.getElementById("register-button").disabled = false;
      }
      function reRegister() {
        teamName = localStorage.getItem("teamName");
        teamPin = localStorage.getItem("teamPin");
        if (teamName && teamPin) {
          fetch("/reRegister", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              teamName,
              pin: teamPin,
              socketId: socket.id,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                showBuzzer(data.teamName, data.description, data.hasPressed);
              } else {
                showRegistrationForm(teamName);
              }
            });
        } else {
          showRegistrationForm();
        }
      }
      function buzz() {
        const now = Date.now();
        if (now - lastBuzzTime > 1000) {
          lastBuzzTime = now;
          socket.emit("buzzerPress", {
            pin: teamPin,
            teamName,
          });
          buzzerButton.disabled = true;
          if ("vibrate" in navigator) {
            navigator.vibrate(200);
          }
        }
      }
      document
        .getElementById("team-registration-form")
        .addEventListener("submit", (event) => {
          event.preventDefault();
          registerTeam();
        });
      buzzerButton.addEventListener("click", buzz);
      buzzerButton.addEventListener("touchstart", buzz);
      socket.on("reset", () => {
        buzzerButton.disabled = false;
        lastBuzzTime = 0;
      });
      document
        .getElementById("changeRegistration")
        .addEventListener("click", () => {
          const newName = prompt("Enter new team name:");
          if (newName && newName !== teamName) {
            fetch("/changeTeamName", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                oldName: teamName,
                newName,
                pin: teamPin,
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  alert(data.message);
                } else {
                  alert("Name change failed: " + data.error);
                }
              });
          }
        });

      socket.on("disconnect", () => {
        reconnectionInterval = setInterval(attemptReconnection, 5000);
      });

      socket.on("connect", () => {
        clearInterval(reconnectionInterval);
        reRegister();
      });

      window.addEventListener("beforeunload", (e) => {
        e.preventDefault();
        e.returnValue = "";
      });

      if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock("portrait").catch(() => {});
      }
    </script>
  </body>
</html>
